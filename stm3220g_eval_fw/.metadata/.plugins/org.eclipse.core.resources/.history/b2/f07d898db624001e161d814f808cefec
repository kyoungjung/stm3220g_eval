/*
 * cmd.c
 *
 *  Created on: 2023. 7. 17.
 *      Author: kjkim
 */

#include "cmd.h"
#include "hw.h"

#define CMD_STX                             0x02
#define CMD_ETX                             0x03

#define CMD_STATE_WAIT_STX                  0
#define CMD_STATE_WAIT_CMD                  1
#define CMD_STATE_WAIT_OPTION_ERROR         2
#define CMD_STATE_WAIT_ERROR                3
#define CMD_STATE_WAITE_LENGTH_L            4
#define CMD_STATE_WAITE_LENGTH_H            5
#define CMD_STATE_WAIT_DATA                 6
#define CMD_STATE_WAIT_CHECKSUM             7
#define CMD_STATE_WAIT_ETX                  8

static void cmdPutch(uint8_t ch, uint8_t data);

/*
 * cmd 초기화
 */
void  cmdInit(cmd_t *p_cmd)
{
  p_cmd->init   = false;
  p_cmd->state  = CMD_STATE_WAIT_STX;   //초기상태는 시작 문자를 기다리는 상태

  p_cmd->tx_packet.error  = 0;
  p_cmd->rx_packetr.error = 0;
}
/*
 * cmd 통신시작
 */
void  cmdBegin(cmd_t *p_cmd, uint8_t ch, uint32_t baud)
{
  p_cmd->ch     = ch;
  p_cmd->baud   = baud;
  p_cmd->init   = true;
  p_cmd->state  = CMD_STATE_WAIT_STX;

  p_cmd->save_time[0] = millis();
  p_cmd->save_time[1] = millis();
}
/*
 * 패킷 수신 함수
 */
bool  cmdReceivePacket(cmd_t *p_cmd);
/*
 * cmd packet 전송 함수
 */
void  cmdSendCmd(cmd_t *p_cmd, uint8_t *p_data, uint32_t length);
/*
 * 응답 packet 전송함수
 */
void cmdSendResp(cmd_t *p_cmd, uint8_t err_code, uint8_t *p_data, uint32_t length);
/*
 * cmd 수신 후 응답전송 함수
 */
bool cmdSendCmdRxResp(cmd_t *p_cmd, uint8_t cmd, uint8_t *p_data, uint32_t length, uint32_t time_out);
